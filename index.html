<!DOCTYPE html>
<html>
<head>
    <title>ğŸš ç¾å›¢å…å•æŸ¥è¯¢</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            padding: 20px 15px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { 
            max-width: 100%;
            background: white; 
            padding: 20px; 
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin: 0 auto;
            position: relative;
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
        }
        .header-buttons {
            position: absolute;
            left: 0;
            top: 0;
            display: flex;
            gap: 8px;
        }
        .add-btn, .delete-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
        }
        .delete-btn {
            background: #dc3545;
        }
        .header h1 {
            color: #07c160;
            font-size: 24px;
            margin: 0 0 8px 0;
            font-weight: 600;
        }
        .header p {
            color: #666;
            font-size: 14px;
            margin: 0;
            opacity: 0.8;
        }
        .input-group {
            margin-bottom: 20px;
        }
        input { 
            width: 100%; 
            padding: 16px; 
            border: 2px solid #e1e5e9; 
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 12px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        input:focus {
            outline: none;
            border-color: #07c160;
            background: white;
            box-shadow: 0 0 0 3px rgba(7, 193, 96, 0.1);
        }
        button { 
            width: 100%;
            padding: 18px; 
            background: linear-gradient(135deg, #07c160, #05a84f);
            color: white; 
            border: none; 
            border-radius: 12px;
            cursor: pointer; 
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3);
            margin-bottom: 10px;
        }
        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(7, 193, 96, 0.3);
        }
        button:disabled { 
            background: #ccc;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        .quick-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            padding: 12px;
            font-size: 16px;
            margin: 5px;
            width: auto;
            flex: 1;
            min-width: 0;
        }
        .batch-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            margin-top: 15px;
        }
        .quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        .result { 
            margin: 20px 0; 
            padding: 16px; 
            border-radius: 12px;
            font-size: 15px;
            text-align: center;
            font-weight: 500;
        }
        .success { 
            background: #e8f5e8; 
            color: #2e7d32; 
            border: 1px solid #c8e6c9;
        }
        .error { 
            background: #ffebee; 
            color: #c62828; 
            border: 1px solid #ffcdd2;
        }
        .loading { 
            background: #e3f2fd; 
            color: #1565c0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .loading::after {
            content: "";
            width: 20px;
            height: 20px;
            border: 2px solid #1565c0;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .records-container {
            margin-top: 25px;
        }
        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .records-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }
        .record-count {
            background: #07c160;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        .record { 
            padding: 16px; 
            margin: 10px 0; 
            background: white;
            border-radius: 12px;
            border-left: 5px solid #07c160;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .amount {
            font-size: 20px;
            font-weight: 700;
            color: #e74c3c;
        }
        .status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-paid {
            background: #e8f5e8;
            color: #07c160;
        }
        .status-unpaid {
            background: #fff3e0;
            color: #ff9800;
        }
        .record-time {
            color: #666;
            font-size: 14px;
        }
        .stats {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-top: 15px;
            text-align: center;
        }
        .stats div {
            margin: 5px 0;
            font-size: 15px;
        }
        .stats .total-amount {
            font-size: 20px;
            font-weight: 700;
            margin: 10px 0;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .tip {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
            text-align: center;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .modal-buttons button {
            flex: 1;
            margin: 0;
        }
        .cancel-btn {
            background: #6c757d;
        }
        .delete-confirm-btn {
            background: #dc3545;
        }
        .account-records {
            margin-top: 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
        }
        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .account-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        .account-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #666;
        }
        .batch-progress {
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        .records-scroll {
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
            padding-right: 5px;
        }
        .records-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .records-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .records-scroll::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        .records-scroll::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .account-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
        }
        .account-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f8f9fa;
        }
        .account-item:last-child {
            border-bottom: none;
        }
        .account-item input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
        }
        .account-info {
            flex: 1;
        }
        .account-item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        .account-item-url {
            font-size: 12px;
            color: #666;
            word-break: break-all;
        }
        .select-all {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .select-all input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-buttons">
                <button class="add-btn" onclick="showAddModal()">ï¼‹ æ·»åŠ </button>
                <button class="delete-btn" onclick="showDeleteModal()">ï¼ åˆ é™¤</button>
            </div>
            <h1>ğŸš ç¾å›¢å…å•æŸ¥è¯¢</h1>
            <p>å°æŸ¿å­æµ‹è¯•ä½¿ç”¨ï¼Œä»…ä¸ºå­¦ä¹ äº¤æµï¼Œç¦æ­¢å¤–ä¼ </p>
        </div>
        
        <div class="tip">
        
        </div>
        
        <div class="input-group">
            <input type="text" id="urlInput" placeholder="ğŸ”— è¯·ç²˜è´´ç¾å›¢å…å•é¡µé¢URL">
            <button onclick="queryOrders()" id="queryBtn">æŸ¥è¯¢å…å•è®°å½•</button>
        </div>

        <!-- å¿«æ·æŒ‰é’®åŒºåŸŸ -->
        <div class="quick-buttons" id="quickButtons">
            <!-- åŠ¨æ€ç”Ÿæˆçš„å¿«æ·æŒ‰é’® -->
        </div>

        <!-- ä¸€é”®æŸ¥è¯¢å…¨éƒ¨æŒ‰é’® -->
        <button class="batch-btn" onclick="batchQueryAll()" id="batchBtn">ğŸš€ ä¸€é”®æŸ¥è¯¢å…¨éƒ¨</button>
        
        <div id="result"></div>
        
        <!-- å•ä¸ªæŸ¥è¯¢ç»“æœæ˜¾ç¤º -->
        <div class="records-container">
            <div id="records"></div>
        </div>

        <!-- å¤šè´¦å·ç»“æœæ˜¾ç¤º -->
        <div id="batchResults"></div>
    </div>

    <!-- æ·»åŠ URLçš„æ¨¡æ€æ¡† -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <h3>æ·»åŠ å…å•é“¾æ¥</h3>
            <input type="text" id="accountName" placeholder="è´¦å·åç§°ï¼ˆä¾‹å¦‚ï¼šå°æŸ¿å­ï¼‰">
            <input type="text" id="accountUrl" placeholder="ç¾å›¢å…å•é¡µé¢URL">
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="hideAddModal()">å–æ¶ˆ</button>
                <button onclick="saveAccount()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤è´¦å·çš„æ¨¡æ€æ¡† -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <h3>é€‰æ‹©è¦åˆ é™¤çš„è´¦å·</h3>
            <div class="select-all">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                <label for="selectAll">å…¨é€‰</label>
            </div>
            <div class="account-list" id="deleteAccountList">
                <!-- åŠ¨æ€ç”Ÿæˆçš„è´¦å·åˆ—è¡¨ -->
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="hideDeleteModal()">å–æ¶ˆ</button>
                <button class="delete-confirm-btn" onclick="confirmDelete()">åˆ é™¤é€‰ä¸­</button>
            </div>
        </div>
    </div>

    <script>
        // å­˜å‚¨è´¦å·æ•°æ®
        let accounts = JSON.parse(localStorage.getItem('meituan_accounts') || '[]');
        
        // åˆå§‹åŒ–æ˜¾ç¤ºå¿«æ·æŒ‰é’®
        updateQuickButtons();

        function showAddModal() {
            document.getElementById('addModal').style.display = 'flex';
            document.getElementById('accountName').focus();
        }

        function hideAddModal() {
            document.getElementById('addModal').style.display = 'none';
            document.getElementById('accountName').value = '';
            document.getElementById('accountUrl').value = '';
        }

        function showDeleteModal() {
            if (accounts.length === 0) {
                showResult('âŒ æ²¡æœ‰å¯åˆ é™¤çš„è´¦å·', 'error');
                return;
            }
            updateDeleteAccountList();
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function hideDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            document.getElementById('selectAll').checked = false;
            const checkboxes = document.querySelectorAll('#deleteAccountList input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        function updateDeleteAccountList() {
            const container = document.getElementById('deleteAccountList');
            container.innerHTML = '';
            
            accounts.forEach((account, index) => {
                const item = document.createElement('div');
                item.className = 'account-item';
                item.innerHTML = `
                    <input type="checkbox" id="account-${index}" value="${index}">
                    <div class="account-info">
                        <div class="account-item-name">${account.name}</div>
                        <div class="account-item-url">${account.url}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const checkboxes = document.querySelectorAll('#deleteAccountList input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = selectAll);
        }

        function confirmDelete() {
            const checkboxes = document.querySelectorAll('#deleteAccountList input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„è´¦å·');
                return;
            }

            const indicesToDelete = Array.from(checkboxes).map(checkbox => parseInt(checkbox.value));
            // ä»å¤§åˆ°å°æ’åºï¼Œé¿å…åˆ é™¤æ—¶ç´¢å¼•å˜åŒ–
            indicesToDelete.sort((a, b) => b - a);
            
            const deletedNames = indicesToDelete.map(index => accounts[index].name);
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${deletedNames.length} ä¸ªè´¦å·å—ï¼Ÿ`)) {
                // æ‰¹é‡åˆ é™¤
                indicesToDelete.forEach(index => {
                    accounts.splice(index, 1);
                });
                
                localStorage.setItem('meituan_accounts', JSON.stringify(accounts));
                updateQuickButtons();
                hideDeleteModal();
                showResult(`âœ… å·²åˆ é™¤ ${deletedNames.length} ä¸ªè´¦å·`, 'success');
            }
        }

        function saveAccount() {
            const name = document.getElementById('accountName').value.trim();
            const url = document.getElementById('accountUrl').value.trim();
            
            if (!name || !url) {
                alert('è¯·å¡«å†™è´¦å·åç§°å’ŒURL');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåç§°
            if (accounts.find(acc => acc.name === name)) {
                alert('è¯¥è´¦å·åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                return;
            }

            // æ·»åŠ åˆ°è´¦å·åˆ—è¡¨
            accounts.push({ name, url });
            localStorage.setItem('meituan_accounts', JSON.stringify(accounts));
            
            // æ›´æ–°ç•Œé¢
            updateQuickButtons();
            hideAddModal();
            showResult(`âœ… å·²ä¿å­˜è´¦å·: ${name}`, 'success');
        }

        function updateQuickButtons() {
            const container = document.getElementById('quickButtons');
            container.innerHTML = '';
            
            accounts.forEach((account, index) => {
                const button = document.createElement('button');
                button.className = 'quick-btn';
                button.innerHTML = `ğŸ‘¤ ${account.name}`;
                button.onclick = () => quickQuery(account.url, account.name);
                container.appendChild(button);
            });
        }

        function quickQuery(url, name) {
            document.getElementById('urlInput').value = url;
            showResult(`ğŸ” æ­£åœ¨æŸ¥è¯¢ ${name}...`, 'loading');
            queryOrders();
        }

        async function batchQueryAll() {
            if (accounts.length === 0) {
                showResult('âŒ è¯·å…ˆæ·»åŠ è´¦å·', 'error');
                return;
            }

            const batchBtn = document.getElementById('batchBtn');
            batchBtn.disabled = true;
            batchBtn.textContent = 'æ‰¹é‡æŸ¥è¯¢ä¸­...';
            
            const resultsContainer = document.getElementById('batchResults');
            resultsContainer.innerHTML = '<div class="batch-progress">å¼€å§‹æ‰¹é‡æŸ¥è¯¢...</div>';
            
            let completed = 0;
            const total = accounts.length;
            
            // æ¸…ç©ºå•ä¸ªæŸ¥è¯¢ç»“æœ
            document.getElementById('records').innerHTML = '';
            document.getElementById('result').innerHTML = '';
            
            for (let i = 0; i < accounts.length; i++) {
                const account = accounts[i];
                const progress = `(${completed + 1}/${total})`;
                
                const progressDiv = resultsContainer.querySelector('.batch-progress');
                if (progressDiv) {
                    progressDiv.textContent = `æŸ¥è¯¢è¿›åº¦: ${progress} - ${account.name}`;
                }
                
                try {
                    const urlParams = parseUrlParams(account.url);
                    const params = generateParams(urlParams);
                    const response = await sendRequest(params);
                    
                    // æ˜¾ç¤ºå•ä¸ªè´¦å·ç»“æœ
                    displayAccountResults(account.name, response.records, resultsContainer);
                    completed++;
                    
                } catch (error) {
                    // æ˜¾ç¤ºé”™è¯¯ç»“æœ
                    displayAccountError(account.name, error.message, resultsContainer);
                    completed++;
                }
                
                // æ›´æ–°è¿›åº¦
                const progressDivUpdate = resultsContainer.querySelector('.batch-progress');
                if (progressDivUpdate) {
                    progressDivUpdate.textContent = `æŸ¥è¯¢è¿›åº¦: ${completed}/${total} - å·²å®Œæˆ`;
                }
            }
            
            // å®Œæˆæ‰¹é‡æŸ¥è¯¢
            batchBtn.disabled = false;
            batchBtn.textContent = 'ğŸš€ ä¸€é”®æŸ¥è¯¢å…¨éƒ¨';
            
            const progressDivFinal = resultsContainer.querySelector('.batch-progress');
            if (progressDivFinal) {
                progressDivFinal.textContent = `âœ… æ‰¹é‡æŸ¥è¯¢å®Œæˆ (${completed}/${total} ä¸ªè´¦å·)`;
                progressDivFinal.style.background = '#e8f5e8';
                progressDivFinal.style.color = '#2e7d32';
            }
        }

        function displayAccountResults(accountName, records, container) {
            const accountDiv = document.createElement('div');
            accountDiv.className = 'account-records';
            
            let totalAmount = 0;
            let unpaidCount = 0;
            
            records.forEach(record => {
                totalAmount += (record.awardPrice || 0) / 100;
                if (record.status !== 2) unpaidCount++;
            });
            
            accountDiv.innerHTML = `
                <div class="account-header">
                    <div class="account-name">ğŸ‘¤ ${accountName}</div>
                    <div class="account-stats">
                        <span>${records.length}æ¡</span>
                        <span>Â¥${totalAmount.toFixed(2)}</span>
                    </div>
                </div>
                ${records.length === 0 ? 
                    '<div class="empty-state"><div class="icon">ğŸ“­</div><div>æœªæ‰¾åˆ°å…å•è®°å½•</div></div>' :
                    `
                    <div class="records-scroll">
                        ${records.map(record => {
                            const amount = (record.awardPrice || 0) / 100;
                            const timestamp = (record.ctime || 0) / 1000;
                            const date = new Date(timestamp * 1000);
                            const status = record.status === 2 ? 'å·²æ‰“æ¬¾' : 'æœªæ‰“æ¬¾';
                            const dateStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                            
                            return `
                                <div class="record">
                                    <div class="record-header">
                                        <div class="amount">Â¥${amount.toFixed(2)}</div>
                                        <div class="status status-${status === 'å·²æ‰“æ¬¾' ? 'paid' : 'unpaid'}">${status}</div>
                                    </div>
                                    <div class="record-time">${dateStr}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    `
                }
                ${records.length > 0 ? `
                    <div class="stats">
                        <div>ğŸ’° æ€»é‡‘é¢</div>
                        <div class="total-amount">Â¥${totalAmount.toFixed(2)}</div>
                        <div>â³ å¾…æ‰“æ¬¾: ${unpaidCount}ç¬”</div>
                    </div>
                ` : ''}
            `;
            
            container.appendChild(accountDiv);
        }

        function displayAccountError(accountName, error, container) {
            const accountDiv = document.createElement('div');
            accountDiv.className = 'account-records';
            accountDiv.innerHTML = `
                <div class="account-header">
                    <div class="account-name">ğŸ‘¤ ${accountName}</div>
                    <div class="account-stats" style="color: #dc3545;">æŸ¥è¯¢å¤±è´¥</div>
                </div>
                <div class="result error">âŒ ${error}</div>
            `;
            container.appendChild(accountDiv);
        }

        // åŸæœ‰çš„æŸ¥è¯¢å‡½æ•°ä¿æŒä¸å˜
        async function queryOrders() {
            const url = document.getElementById('urlInput').value;
            const btn = document.getElementById('queryBtn');
            const resultDiv = document.getElementById('result');
            const recordsDiv = document.getElementById('records');
            
            if (!url) {
                showResult('è¯·è¾“å…¥ç¾å›¢å…å•é¡µé¢URL', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æŸ¥è¯¢ä¸­...';
            showResult('æ­£åœ¨å‘é€è¯·æ±‚...', 'loading');
            recordsDiv.innerHTML = '';

            try {
                const urlParams = parseUrlParams(url);
                const params = generateParams(urlParams);
                const response = await sendRequest(params);
                
                if (response.success) {
                    showResult(`âœ… ${response.message}`, 'success');
                    displayRecords(response.records);
                } else {
                    showResult(`âŒ ${response.message}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'æŸ¥è¯¢å…å•è®°å½•';
            }
        }

        function displayRecords(records) {
            const recordsDiv = document.getElementById('records');
            
            if (records.length === 0) {
                recordsDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“­</div>
                        <div>æœªæ‰¾åˆ°å…å•è®°å½•</div>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="records-header">
                    <h3>ğŸ“‹ å…å•è®°å½•</h3>
                    <div class="record-count">${records.length}æ¡</div>
                </div>
                <div class="records-scroll">
            `;
            
            records.sort((a, b) => (b.ctime || 0) - (a.ctime || 0));
            
            let totalAmount = 0;
            let unpaidCount = 0;
            
            records.forEach((record) => {
                const amount = (record.awardPrice || 0) / 100;
                const timestamp = (record.ctime || 0) / 1000;
                const date = new Date(timestamp * 1000);
                const status = record.status === 2 ? 'å·²æ‰“æ¬¾' : 'æœªæ‰“æ¬¾';
                
                totalAmount += amount;
                if (status === 'æœªæ‰“æ¬¾') unpaidCount++;
                
                const dateStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                html += `
                    <div class="record">
                        <div class="record-header">
                            <div class="amount">Â¥${amount.toFixed(2)}</div>
                            <div class="status status-${status === 'å·²æ‰“æ¬¾' ? 'paid' : 'unpaid'}">${status}</div>
                        </div>
                        <div class="record-time">${dateStr}</div>
                    </div>
                `;
            });

            html += `</div>
                <div class="stats">
                    <div>ğŸ’° æ€»é‡‘é¢</div>
                    <div class="total-amount">Â¥${totalAmount.toFixed(2)}</div>
                    <div>â³ å¾…æ‰“æ¬¾: ${unpaidCount}ç¬”</div>
                </div>
            `;

            recordsDiv.innerHTML = html;
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = `result ${type}`;
        }

        // åŸæœ‰çš„è§£æURLã€ç”Ÿæˆå‚æ•°ã€å‘é€è¯·æ±‚ç­‰å‡½æ•°ä¿æŒä¸å˜
        function parseUrlParams(url) {
            try {
                const urlObj = new URL(url);
                const params = new URLSearchParams(urlObj.search);
                const userid = params.get('userId') || params.get('userid') || '3305650384';
                const token = params.get('token') || params.get('userToken');
                if (!token) throw new Error('æ— æ³•ä»URLä¸­è§£æå‡ºtoken');
                return { userid, token };
            } catch (e) {
                throw new Error('URLæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®');
            }
        }

        function generateParams(urlParams) {
            const dynamicParams = {
                platform: '3', version: '12.45.210', wm_appversion: '12.45.210',
                wm_ctype: 'mtandroid', wm_dtype: 'RMX5010', wm_did: generateUUID(),
                wm_visitid: generateUUID() + Date.now(), wm_uuid: generateUUID(),
                uuid: generateUUID(), msid: generateUUID() + Date.now(),
                mt_back_rci: '410300', wm_longitude: (112454000 + Math.floor(Math.random() * 10000)).toString(),
                wm_latitude: (34619000 + Math.floor(Math.random() * 5000)).toString(),
                scene_id: '179', page_num: '1', page_size: '10',
            };
            return {
                ...dynamicParams,
                userid: urlParams.userid, token: urlParams.token, wm_logintoken: urlParams.token,
                wm_context: '', entry: 'tiantianmiandan', entry_channel: '2',
            };
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            }).toUpperCase();
        }

        async function sendRequest(params) {
            const formData = new URLSearchParams();
            for (const [key, value] of Object.entries(params)) {
                formData.append(key, value);
            }

            const response = await fetch('https://adapi.waimai.meituan.com/api/ad/landingPage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Origin': 'https://adfec.meituan.com',
                    'Referer': 'https://adfec.meituan.com/',
                    'User-Agent': 'Mozilla/5.0 (Linux; Android 13; RMX5010) AppleWebKit/537.36',
                    'Accept': 'application/json, text/plain, */*',
                    'Accept-Language': 'zh-CN,zh-Hans;q=0.9'
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.code !== 0) {
                throw new Error(`APIé”™è¯¯: ${data.code} - ${data.msg}`);
            }

            const records = extractRecords(data);
            
            return {
                success: true,
                message: `æˆåŠŸæ‰¾åˆ°${records.length}æ¡å…å•è®°å½•`,
                records: records
            };
        }

        function extractRecords(data) {
            try {
                const moduleActivityList = data.data?.module_activity_list || {};
                if (moduleActivityList.string_data) {
                    const activityData = JSON.parse(moduleActivityList.string_data);
                    return activityData.freeOrderRecord || [];
                }
            } catch (e) {
                console.error('è§£æè®°å½•å¤±è´¥:', e);
            }
            return [];
        }

        // æŒ‰å›è½¦é”®ä¹Ÿå¯ä»¥æŸ¥è¯¢
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                queryOrders();
            }
        });

        // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
        document.getElementById('urlInput').focus();
    </script>
</body>
</html>
