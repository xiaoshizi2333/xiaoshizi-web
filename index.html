<!DOCTYPE html>
<html>
<head>
    <title>ğŸš ç¾å›¢å…å•æŸ¥è¯¢</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        input, button { padding: 12px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; }
        input { width: 70%; }
        button { background: #07c160; color: white; border: none; cursor: pointer; }
        button:disabled { background: #ccc; }
        .result { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .record { padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #07c160; }
        .loading { color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš ç¾å›¢å…å•æŸ¥è¯¢</h1>
        <p>å°æŸ¿å­æµ‹è¯•ä½¿ç”¨ï¼Œä»…ä¸ºå­¦ä¹ äº¤æµï¼Œç¦æ­¢å¤–ä¼ </p>
        
        <div>
            <input type="text" id="urlInput" placeholder="å°æŸ¿å­ä¸“ç”¨">
            <button onclick="queryOrders()" id="queryBtn">æŸ¥è¯¢å…å•è®°å½•</button>
        </div>
        
        <div id="result"></div>
        <div id="records"></div>
    </div>

    <script>
        async function queryOrders() {
            const url = document.getElementById('urlInput').value;
            const btn = document.getElementById('queryBtn');
            const resultDiv = document.getElementById('result');
            const recordsDiv = document.getElementById('records');
            
            if (!url) {
                showResult('è¯·è¾“å…¥URL', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æŸ¥è¯¢ä¸­...';
            showResult('æ­£åœ¨å‘é€è¯·æ±‚...', 'loading');
            recordsDiv.innerHTML = '';

            try {
                // è§£æURLå‚æ•°
                const urlParams = parseUrlParams(url);
                
                // ç”Ÿæˆ20ä¸ªå‚æ•°
                const params = generateParams(urlParams);
                
                // å‘é€è¯·æ±‚
                const response = await sendRequest(params);
                
                if (response.success) {
                    showResult(`âœ… ${response.message}`, 'success');
                    displayRecords(response.records);
                } else {
                    showResult(`âŒ ${response.message}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ è¯·æ±‚å¤±è´¥: ${error}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'æŸ¥è¯¢å…å•è®°å½•';
            }
        }

        function parseUrlParams(url) {
            try {
                const urlObj = new URL(url);
                const params = new URLSearchParams(urlObj.search);
                
                const userid = params.get('userId') || params.get('userid') || '3305650384';
                const token = params.get('token') || params.get('userToken');
                
                if (!token) throw new Error('æ— æ³•ä»URLä¸­è§£æå‡ºtoken');
                
                return { userid, token };
            } catch (e) {
                throw new Error('URLè§£æå¤±è´¥: ' + e.message);
            }
        }

        function generateParams(urlParams) {
            // ç”Ÿæˆ16ä¸ªéšæœºå‚æ•°
            const dynamicParams = {
                platform: '3',
                version: '12.45.210',
                wm_appversion: '12.45.210',
                wm_ctype: 'mtandroid',
                wm_dtype: 'RMX5010',
                wm_did: generateUUID(),
                
                wm_visitid: generateUUID() + Date.now(),
                wm_uuid: generateUUID(),
                uuid: generateUUID(),
                msid: generateUUID() + Date.now(),
                
                mt_back_rci: '410300',
                wm_longitude: '112454000',
                wm_latitude: '34619000',
                
                scene_id: '179',
                page_num: '1',
                page_size: '10',
            };

            // åˆå¹¶20ä¸ªå‚æ•°
            return {
                ...dynamicParams,
                userid: urlParams.userid,
                token: urlParams.token,
                wm_logintoken: urlParams.token,
                wm_context: '',
                entry: 'tiantianmiandan',
                entry_channel: '2',
            };
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            }).toUpperCase();
        }

        async function sendRequest(params) {
            const formData = new URLSearchParams();
            for (const [key, value] of Object.entries(params)) {
                formData.append(key, value);
            }

            const response = await fetch('https://adapi.waimai.meituan.com/api/ad/landingPage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Origin': 'https://adfec.meituan.com',
                    'Referer': 'https://adfec.meituan.com/',
                    'User-Agent': 'Mozilla/5.0 (Linux; Android 13; RMX5010) AppleWebKit/537.36'
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.code !== 0) {
                throw new Error(`APIé”™è¯¯: ${data.code} - ${data.msg}`);
            }

            const records = extractRecords(data);
            
            return {
                success: true,
                message: `æˆåŠŸæ‰¾åˆ°${records.length}æ¡è®°å½•`,
                records: records
            };
        }

        function extractRecords(data) {
            try {
                const moduleActivityList = data.data?.module_activity_list || {};
                if (moduleActivityList.string_data) {
                    const activityData = JSON.parse(moduleActivityList.string_data);
                    return activityData.freeOrderRecord || [];
                }
            } catch (e) {
                console.error('è§£æè®°å½•å¤±è´¥:', e);
            }
            return [];
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = `result ${type}`;
        }

        function displayRecords(records) {
            const recordsDiv = document.getElementById('records');
            
            if (records.length === 0) {
                recordsDiv.innerHTML = '<div class="result">ğŸ“­ æœªæ‰¾åˆ°å…å•è®°å½•</div>';
                return;
            }

            let html = `<h3>ğŸ“‹ å…å•è®°å½• (å…±${records.length}æ¡)</h3>`;
            
            records.forEach((record, index) => {
                const amount = (record.awardPrice || 0) / 100;
                const timestamp = (record.ctime || 0) / 1000;
                const date = new Date(timestamp * 1000);
                const status = record.status === 2 ? 'å·²æ‰“æ¬¾' : 'æœªæ‰“æ¬¾';
                const statusColor = status === 'å·²æ‰“æ¬¾' ? '#07c160' : '#ff6b35';
                
                html += `
                    <div class="record">
                        <strong>Â¥${amount.toFixed(2)}</strong> - 
                        ${date.toLocaleString()} - 
                        <span style="color: ${statusColor}">${status}</span>
                    </div>
                `;
            });

            recordsDiv.innerHTML = html;
        }

        // ç¤ºä¾‹URL
        document.getElementById('urlInput').value = '';
    </script>
</body>
</html>