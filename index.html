<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æŸ¿å­å‘•å¿ƒæ²¥è¡€åˆ¶ä½œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1em;
        }
        
        .input-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .input-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .input-row input {
            flex: 1;
            min-width: 200px;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
            white-space: nowrap;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        
        .btn-clear {
            background: #6c757d;
        }
        
        .btn-delete {
            background: #dc3545;
        }
        
        .search-section {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
        }
        
        .search-box::after {
            content: 'ğŸ”';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }
        
        .results-section {
            padding: 20px;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
            min-width: 100px;
        }
        
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #1976d2;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .shop-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .shop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        .shop-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .shop-info {
            color: #666;
            font-size: 0.9em;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 15px;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .link-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            word-break: break-all;
            font-family: monospace;
            border: 1px solid #e9ecef;
        }
        
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background 0.3s;
        }
        
        .copy-btn:hover {
            background: #218838;
        }
        
        .hidden {
            display: none;
        }
        
        .progress {
            margin: 15px 0;
            background: #e9ecef;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
        
        .config-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .config-item {
            padding: 10px 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .config-item:hover {
            background: #f8f9fa;
        }
        
        .config-item:last-child {
            border-bottom: none;
        }
        
        .config-actions {
            display: flex;
            gap: 5px;
        }
        
        .small-btn {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .input-section, .results-section {
                padding: 15px;
            }
            
            .btn {
                padding: 10px 12px;
                font-size: 13px;
                margin-right: 5px;
                margin-bottom: 5px;
            }
            
            .shop-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .stat-item {
                min-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.3em;
            }
            
            .input-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-row input {
                min-width: 100%;
            }
            
            .btn {
                width: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” å°æŸ¿å­ä¸“ç”¨è§£æç½‘ç«™</h1>
            <p>ä»…ç”¨äºå­¦ä¹ äº¤æµï¼Œä¸å¯ç”¨äºéæ³•ç”¨é€”å’Œå¤–ä¼ </p>
        </div>
        
        <div class="input-section">
            <div class="input-group">
                <label for="urlInput">ğŸ”— ç¾å›¢URLï¼ˆåŒ…å«Tokenï¼‰</label>
                <div class="input-row">
                    <input type="text" id="urlInput" placeholder="ç²˜è´´åŒ…å«tokençš„URLï¼Œä¾‹å¦‚ï¼šhttps://i.meituan.com/...?token=xxx">
                    <button class="btn" id="addConfigBtn">â• ä¿å­˜</button>
                    <button class="btn" id="selectConfigBtn">ğŸ“ é€‰æ‹©é…ç½®</button>
                    <button class="btn btn-clear" id="clearUrlBtn">ğŸ—‘ï¸ æ¸…é™¤</button>
                    <button class="btn btn-delete" id="deleteConfigBtn">âŒ åˆ é™¤é…ç½®</button>
                </div>
            </div>
            
            <div class="input-group">
                <label for="coordinateInput">ğŸ“ ç»çº¬åº¦ï¼ˆæ ¼å¼ï¼šç»åº¦,çº¬åº¦ï¼‰</label>
                <div class="input-row">
                    <input type="text" id="coordinateInput" placeholder="ä¾‹å¦‚ï¼š000.000000,000.000000">
                    <button class="btn btn-clear" id="clearCoordinateBtn">ğŸ—‘ï¸ æ¸…é™¤</button>
                </div>
            </div>
            
            <div>
                <button class="btn" id="startBtn">ğŸš€ å¼€å§‹è§£æåº—é“º</button>
                <button class="btn btn-stop" id="stopBtn" disabled>â¹ï¸ åœæ­¢è§£æ</button>
            </div>
            
            <div class="progress hidden" id="progressBar">
                <div class="progress-bar" id="progressFill" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢åº—é“ºåç§°...">
            </div>
        </div>
        
        <div class="results-section">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalShops">0</div>
                    <div class="stat-label">æ€»åº—é“ºæ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="currentPage">0</div>
                    <div class="stat-label">å½“å‰é¡µç </div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="foundPages">0</div>
                    <div class="stat-label">å·²å‘ç°é¡µæ•°</div>
                </div>
            </div>
            
            <div id="resultsContainer">
                <div class="loading hidden" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨è§£æåº—é“ºæ•°æ®...</p>
                    <p id="loadingStatus">æ­£åœ¨æŸ¥è¯¢ç¬¬ 0 é¡µ</p>
                </div>
                
                <div id="shopList" class="shop-grid"></div>
            </div>
        </div>
    </div>
    
    <!-- é“¾æ¥æ¨¡æ€æ¡† -->
    <div class="modal" id="linkModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ”— åº—é“ºé“¾æ¥</div>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div id="modalShopName" style="margin-bottom: 15px; font-weight: 600;"></div>
            <div class="link-box" id="modalLink"></div>
            <button class="copy-btn" id="copyLinkBtn">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
        </div>
    </div>
    
    <!-- ä¿å­˜é…ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="saveConfigModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ’¾ ä¿å­˜é…ç½®</div>
                <button class="close-btn" id="closeSaveConfigModal">&times;</button>
            </div>
            <div class="input-group">
                <label for="configName">é…ç½®åç§°</label>
                <input type="text" id="configName" placeholder="è¾“å…¥é…ç½®åç§°">
            </div>
            <button class="btn" id="saveConfigConfirmBtn" style="width: 100%;">ä¿å­˜é…ç½®</button>
        </div>
    </div>
    
    <!-- é€‰æ‹©é…ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="selectConfigModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ“ é€‰æ‹©é…ç½®</div>
                <button class="close-btn" id="closeSelectConfigModal">&times;</button>
            </div>
            <div class="config-list" id="configList">
                <!-- é…ç½®åˆ—è¡¨ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button class="btn" id="useCustomConfigBtn" style="width: 100%; margin-top: 10px;">ä½¿ç”¨è‡ªå®šä¹‰è¾“å…¥</button>
        </div>
    </div>
    
    <!-- åˆ é™¤é…ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="deleteConfigModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">âŒ åˆ é™¤é…ç½®</div>
                <button class="close-btn" id="closeDeleteConfigModal">&times;</button>
            </div>
            <div class="config-list" id="deleteConfigList">
                <!-- åˆ é™¤é…ç½®åˆ—è¡¨ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        class MeituanParser {
            constructor() {
                this.allShops = [];
                this.currentPage = 0;
                this.foundPages = 0;
                this.isLoading = false;
                this.shouldStop = false;
                this.savedConfigs = JSON.parse(localStorage.getItem('meituanConfigs') || '{}');
                this.currentConfig = 'custom';
                
                this.initializeEventListeners();
                this.updateDeleteConfigList();
            }
            
            initializeEventListeners() {
                document.getElementById('startBtn').addEventListener('click', () => this.startParsing());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopParsing());
                document.getElementById('searchInput').addEventListener('input', (e) => this.filterShops(e.target.value));
                document.getElementById('closeModal').addEventListener('click', () => this.closeModal());
                document.getElementById('copyLinkBtn').addEventListener('click', () => this.copyLink());
                
                // é…ç½®ç®¡ç†ç›¸å…³äº‹ä»¶
                document.getElementById('addConfigBtn').addEventListener('click', () => this.showSaveConfigModal());
                document.getElementById('selectConfigBtn').addEventListener('click', () => this.showSelectConfigModal());
                document.getElementById('clearUrlBtn').addEventListener('click', () => this.clearUrl());
                document.getElementById('clearCoordinateBtn').addEventListener('click', () => this.clearCoordinate());
                document.getElementById('deleteConfigBtn').addEventListener('click', () => this.showDeleteConfigModal());
                
                // é…ç½®æ¨¡æ€æ¡†äº‹ä»¶
                document.getElementById('closeSaveConfigModal').addEventListener('click', () => this.closeSaveConfigModal());
                document.getElementById('saveConfigConfirmBtn').addEventListener('click', () => this.saveConfig());
                document.getElementById('closeSelectConfigModal').addEventListener('click', () => this.closeSelectConfigModal());
                document.getElementById('useCustomConfigBtn').addEventListener('click', () => this.useCustomConfig());
                document.getElementById('closeDeleteConfigModal').addEventListener('click', () => this.closeDeleteConfigModal());
                
                // å…³é—­æ¨¡æ€æ¡†ç‚¹å‡»èƒŒæ™¯
                document.getElementById('linkModal').addEventListener('click', (e) => {
                    if (e.target.id === 'linkModal') this.closeModal();
                });
                document.getElementById('saveConfigModal').addEventListener('click', (e) => {
                    if (e.target.id === 'saveConfigModal') this.closeSaveConfigModal();
                });
                document.getElementById('selectConfigModal').addEventListener('click', (e) => {
                    if (e.target.id === 'selectConfigModal') this.closeSelectConfigModal();
                });
                document.getElementById('deleteConfigModal').addEventListener('click', (e) => {
                    if (e.target.id === 'deleteConfigModal') this.closeDeleteConfigModal();
                });
            }
            
            // é…ç½®ç®¡ç†æ–¹æ³•
            showSaveConfigModal() {
                const url = document.getElementById('urlInput').value.trim();
                const coordinate = document.getElementById('coordinateInput').value.trim();
                
                if (!url || !coordinate) {
                    alert('è¯·å…ˆå¡«å†™URLå’Œç»çº¬åº¦');
                    return;
                }
                
                document.getElementById('configName').value = '';
                document.getElementById('saveConfigModal').style.display = 'block';
            }
            
            closeSaveConfigModal() {
                document.getElementById('saveConfigModal').style.display = 'none';
            }
            
            saveConfig() {
                const name = document.getElementById('configName').value.trim();
                const url = document.getElementById('urlInput').value.trim();
                const coordinate = document.getElementById('coordinateInput').value.trim();
                
                if (!name) {
                    alert('è¯·è¾“å…¥é…ç½®åç§°');
                    return;
                }
                
                this.savedConfigs[name] = {
                    url: url,
                    coordinate: coordinate,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('meituanConfigs', JSON.stringify(this.savedConfigs));
                this.closeSaveConfigModal();
                alert(`é…ç½® "${name}" ä¿å­˜æˆåŠŸï¼`);
            }
            
            showSelectConfigModal() {
                const configList = document.getElementById('configList');
                configList.innerHTML = '';
                
                Object.keys(this.savedConfigs).forEach(name => {
                    const configItem = document.createElement('div');
                    configItem.className = 'config-item';
                    configItem.innerHTML = `
                        <span>${name}</span>
                        <span>${new Date(this.savedConfigs[name].timestamp).toLocaleDateString()}</span>
                    `;
                    configItem.addEventListener('click', () => this.selectConfig(name));
                    configList.appendChild(configItem);
                });
                
                document.getElementById('selectConfigModal').style.display = 'block';
            }
            
            closeSelectConfigModal() {
                document.getElementById('selectConfigModal').style.display = 'none';
            }
            
            selectConfig(name) {
                const config = this.savedConfigs[name];
                document.getElementById('urlInput').value = config.url;
                document.getElementById('coordinateInput').value = config.coordinate;
                this.currentConfig = name;
                this.closeSelectConfigModal();
            }
            
            useCustomConfig() {
                this.currentConfig = 'custom';
                this.closeSelectConfigModal();
            }
            
            clearUrl() {
                document.getElementById('urlInput').value = '';
            }
            
            clearCoordinate() {
                document.getElementById('coordinateInput').value = '';
            }
            
            showDeleteConfigModal() {
                this.updateDeleteConfigList();
                document.getElementById('deleteConfigModal').style.display = 'block';
            }
            
            closeDeleteConfigModal() {
                document.getElementById('deleteConfigModal').style.display = 'none';
            }
            
            updateDeleteConfigList() {
                const deleteConfigList = document.getElementById('deleteConfigList');
                deleteConfigList.innerHTML = '';
                
                Object.keys(this.savedConfigs).forEach(name => {
                    const configItem = document.createElement('div');
                    configItem.className = 'config-item';
                    configItem.innerHTML = `
                        <span>${name}</span>
                        <div class="config-actions">
                            <button class="btn btn-delete small-btn" data-name="${name}">åˆ é™¤</button>
                        </div>
                    `;
                    deleteConfigList.appendChild(configItem);
                });
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
                deleteConfigList.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const name = btn.getAttribute('data-name');
                        this.deleteConfig(name);
                    });
                });
            }
            
            deleteConfig(name) {
                if (confirm(`ç¡®å®šè¦åˆ é™¤é…ç½® "${name}" å—ï¼Ÿ`)) {
                    delete this.savedConfigs[name];
                    localStorage.setItem('meituanConfigs', JSON.stringify(this.savedConfigs));
                    this.updateDeleteConfigList();
                    if (this.currentConfig === name) {
                        this.currentConfig = 'custom';
                    }
                }
            }
            
            async startParsing() {
                const url = document.getElementById('urlInput').value.trim();
                const coordinate = document.getElementById('coordinateInput').value.trim();
                
                if (!url) {
                    alert('è¯·è¾“å…¥åŒ…å«tokençš„URL');
                    return;
                }
                
                if (!coordinate) {
                    alert('è¯·è¾“å…¥ç»çº¬åº¦');
                    return;
                }
                
                // è§£æç»çº¬åº¦
                const [longitude, latitude] = this.parseCoordinate(coordinate);
                if (!longitude || !latitude) {
                    alert('ç»çº¬åº¦æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨"ç»åº¦,çº¬åº¦"æ ¼å¼');
                    return;
                }

                const token = this.extractTokenFromUrl(url);
                if (!token) {
                    alert('æ— æ³•ä»URLä¸­æå–tokenï¼Œè¯·æ£€æŸ¥URLæ ¼å¼');
                    return;
                }
                
                // æ¸…ç©ºä¹‹å‰çš„æŸ¥è¯¢ç»“æœ
                this.clearPreviousResults();
                
                this.shouldStop = false;
                this.showLoading(true);
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('progressBar').classList.remove('hidden');
                
                try {
                    await this.parseAllPages(token, longitude, latitude);
                } catch (error) {
                    console.error('è§£æå¤±è´¥:', error);
                    alert('è§£æå¤±è´¥: ' + error.message);
                } finally {
                    this.showLoading(false);
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('progressBar').classList.add('hidden');
                }
            }
            
            // æ¸…ç©ºä¹‹å‰çš„æŸ¥è¯¢ç»“æœ
            clearPreviousResults() {
                this.allShops = [];
                this.currentPage = 0;
                this.foundPages = 0;
                this.updateStats();
                this.displayShops();
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('searchInput').value = '';
            }
            
            stopParsing() {
                this.shouldStop = true;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('startBtn').disabled = false;
            }
            
            parseCoordinate(coordinate) {
                const parts = coordinate.split(',');
                if (parts.length !== 2) return [null, null];
                
                const longitude = parseFloat(parts[0].trim());
                const latitude = parseFloat(parts[1].trim());
                
                if (isNaN(longitude) || isNaN(latitude)) return [null, null];
                
                return [longitude, latitude];
            }
            
            extractTokenFromUrl(url) {
                const tokenMatch = url.match(/token=([A-Za-z0-9_-]+)/);
                return tokenMatch ? tokenMatch[1] : null;
            }
            
            async parseAllPages(token, longitude, latitude) {
                let page = 0;
                let hasMorePages = true;
                
                while (hasMorePages && page < 50 && !this.shouldStop) {
                    this.currentPage = page;
                    this.updateProgress(page);
                    
                    const shops = await this.fetchPage(token, longitude, latitude, page);
                    
                    if (shops && shops.length > 0) {
                        this.allShops.push(...shops);
                        this.foundPages = page + 1;
                        this.updateStats();
                        this.displayShops();
                        page++;
                    } else {
                        hasMorePages = false;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            updateProgress(page) {
                const progress = Math.min((page / 50) * 100, 100);
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('loadingStatus').textContent = `æ­£åœ¨æŸ¥è¯¢ç¬¬ ${page} é¡µ`;
            }
            
            async fetchPage(token, longitude, latitude, pageNum) {
                const wmLongitude = Math.round(parseFloat(longitude) * 1000000);
                const wmLatitude = Math.round(parseFloat(latitude) * 1000000);
                
                // 12ä¸ªè¯·æ±‚å‚æ•°
                const params = {
                    'wm_logintoken': token,
                    'wm_longitude': wmLongitude.toString(),
                    'wm_latitude': wmLatitude.toString(),
                    'wm_appversion': '9.86.2',
                    'scene_id': '344',
                    'page_num': pageNum.toString(),
                    'page_size': '10',
                    'wm_ctype': 'wxapp',
                    // ç©ºå€¼å‚æ•°
                    'wm_uuid': '',
                    'wm_visitid': '',
                    'wm_dtype': '',
                    'ctype': ''
                };
                
                const formData = new URLSearchParams();
                for (const [key, value] of Object.entries(params)) {
                    formData.append(key, value);
                }
                
                try {
                    const response = await fetch('https://adapi.waimai.meituan.com/api/ad/landingPage', {
                        method: 'POST',
                        headers: {
                            'Host': 'adapi.waimai.meituan.com',
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Origin': 'https://adfec.meituan.com',
                            'Accept': 'application/json, text/plain, */*',
                            'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 15_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/8.0.61(0x18003d39) NetType/WIFI Language/zh_CN miniProgram/wx2c348cf579062e56',
                            'Referer': 'https://adfec.meituan.com/',
                            'Accept-Language': 'zh-CN,zh-Hans;q=0.9'
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.code === 0) {
                        return this.extractShopsFromResponse(data);
                    } else {
                        return [];
                    }
                } catch (error) {
                    return [];
                }
            }
            
            extractShopsFromResponse(data) {
                const shops = [];
                const moduleList = data.data?.module_list || [];
                
                moduleList.forEach(module => {
                    try {
                        const stringData = module.string_data;
                        if (stringData) {
                            const moduleData = JSON.parse(stringData);
                            const adDataStr = moduleData.ad_data;
                            if (adDataStr) {
                                const adData = JSON.parse(adDataStr);
                                const shopName = adData.poi_name;
                                
                                if (shopName) {
                                    // æŸ¥æ‰¾åº—é“ºé“¾æ¥
                                    const shopLinks = this.findShopLinks(adData);
                                    
                                    shopLinks.forEach(link => {
                                        shops.push({
                                            name: shopName,
                                            fullLink: link,
                                            distance: adData.distance || '',
                                            deliveryTime: adData.avg_delivery_time || ''
                                        });
                                    });
                                }
                            }
                        }
                    } catch (e) {
                        console.error('è§£æåº—é“ºæ•°æ®å¤±è´¥:', e);
                    }
                });
                
                return shops;
            }
            
            // æŸ¥æ‰¾ç¬¦åˆæ ¼å¼çš„åº—é“ºé“¾æ¥
            findShopLinks(adData) {
                const links = [];
                const linkPattern = /https:\/\/wxapp\/packages\/restaurant\/restaurant\/restaurant\?poi_id=-100&allowance_alliance_scenes=[^&]+&poi_id_str=[^&]+/g;
                
                // æ£€æŸ¥schemeå­—æ®µ
                if (adData.scheme) {
                    const matches = adData.scheme.match(linkPattern);
                    if (matches) {
                        links.push(...matches);
                    }
                }
                
                // æ£€æŸ¥sku_listä¸­çš„scheme
                if (adData.sku_list && Array.isArray(adData.sku_list)) {
                    adData.sku_list.forEach(sku => {
                        if (sku.scheme) {
                            const matches = sku.scheme.match(linkPattern);
                            if (matches) {
                                links.push(...matches);
                            }
                        }
                    });
                }
                
                return [...new Set(links)]; // å»é‡
            }
            
            displayShops() {
                const shopList = document.getElementById('shopList');
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                
                let filteredShops = this.allShops;
                if (searchTerm) {
                    filteredShops = this.allShops.filter(shop => 
                        shop.name.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (filteredShops.length === 0) {
                    shopList.innerHTML = '<div class="loading"><p>æ²¡æœ‰æ‰¾åˆ°åº—é“º</p></div>';
                    return;
                }
                
                shopList.innerHTML = filteredShops.map((shop, index) => `
                    <div class="shop-card" onclick="parser.showShopLink('${this.escapeHtml(shop.name)}', '${this.escapeHtml(shop.fullLink)}')">
                        <div class="shop-name">${this.escapeHtml(shop.name)}</div>
                        <div class="shop-info">
                            ${shop.distance ? `è·ç¦»: ${shop.distance}` : ''}
                            ${shop.deliveryTime ? ` | é…é€: ${shop.deliveryTime}åˆ†é’Ÿ` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            showShopLink(shopName, fullLink) {
                document.getElementById('modalShopName').textContent = shopName;
                document.getElementById('modalLink').textContent = fullLink;
                document.getElementById('linkModal').style.display = 'block';
            }
            
            closeModal() {
                document.getElementById('linkModal').style.display = 'none';
            }
            
            async copyLink() {
                const link = document.getElementById('modalLink').textContent;
                try {
                    await navigator.clipboard.writeText(link);
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                } catch (err) {
                    const textArea = document.createElement('textarea');
                    textArea.value = link;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }
            }
            
            filterShops(searchTerm) {
                this.displayShops();
            }
            
            updateStats() {
                document.getElementById('totalShops').textContent = this.allShops.length;
                document.getElementById('currentPage').textContent = this.currentPage;
                document.getElementById('foundPages').textContent = this.foundPages;
            }
            
            showLoading(show) {
                document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
                if (!show) {
                    document.getElementById('shopList').classList.remove('hidden');
                }
            }
            
            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        }
        
        // åˆå§‹åŒ–è§£æå™¨
        const parser = new MeituanParser();
    </script>
</body>
</html>
